stages:
  - build-base
  - deploy-base
  - build
  - deploy

before_script:
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

# Building base containers the base containers should have all the required
# dependencies it should not be necessary to build them every time
build-ws-base:
  variables:
    IMAGE_TAG: "datafed-web-base"
  stage: build-base
  tags:
    - datafed
  script:
    - docker build -f dockerfiles/Dockerfile.web-base.ubuntu -t ${IMAGE_TAG} .

build-core-base:
  variables:
    IMAGE_TAG: "datafed-core-base"
  stage: build-base
  tags:
    - datafed
  script:
    - docker build -f dockerfiles/Dockerfile.core-base.ubuntu -t ${IMAGE_TAG} .

build-repo-base:
  variables:
    IMAGE_TAG: "datafed-repo-base"
  stage: build-base
  tags:
    - datafed
  script:
    - docker build -f dockerfiles/Dockerfile.repo-base.ubuntu -t ${IMAGE_TAG} .

# Deploying base containers
deploy-ws-base:
  stage: deploy-base
  needs: ["build-ws-base"]
  tags:
    - datafed
  script:
    - docker push datafed-web-base

deploy-core-base:
  stage: deploy-base
  needs: ["build-core-base"]
  tags:
    - datafed
  script:
    - docker push datafed-core-base

deploy-repo-base:
  stage: deploy-base
  needs: ["build-repo-base"]
  tags:
    - datafed
  script:
    - docker push datafed-repo-base

# Building containers for running services
build-ws:
  variables:
    IMAGE_TAG: "datafed-web:$CI_COMMIT_REF_NAME"
  stage: build
  tags:
    - datafed
  script:
    - docker build -f dockerfiles/Dockerfile.web.ubuntu -t ${IMAGE_TAG} .

build-core:
  variables:
    IMAGE_TAG: "datafed-core:$CI_COMMIT_REF_NAME"
  stage: build
  tags:
    - datafed
  script:
    - docker build -f dockerfiles/Dockerfile.core.ubuntu -t ${IMAGE_TAG} .

build-repo:
  variables:
    IMAGE_TAG: "datafed-repo:$CI_COMMIT_REF_NAME"
  stage: build
  tags:
    - datafed
  script:
    - docker build -f dockerfiles/Dockerfile.repo-base.ubuntu -t ${IMAGE_TAG} .

# Deploying containers for running services
deploy-ws:
  stage: deploy
  needs: ["build-ws"]
  variables:
    IMAGE_TAG: "datafed-web:$CI_COMMIT_REF_NAME"
  tags:
    - datafed
  script:
    - docker push ${IMAGE_TAG}

deploy-core:
  stage: deploy
  needs: ["build-core"]
  variables:
    IMAGE_TAG: "datafed-core:$CI_COMMIT_REF_NAME"
  tags:
    - datafed
  script:
    - docker push ${IMAGE_TAG}

deploy-repo:
  stage: deploy
  needs: ["build-repo"]
  variables:
    IMAGE_TAG: "datafed-repo:$CI_COMMIT_REF_NAME"
  tags:
    - datafed
  script:
    - docker push ${IMAGE_TAG}

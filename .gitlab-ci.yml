stages:
  - ci-infrastructure-check
  - trigger-infrastructure
  - signal
  - clear-docker-cache
  - build-base
  - provision-client
  - build
  - end-to-end-setup-arango
  - end-to-end-setup
  - end-to-end-test
  - deploy-pypi-package

# WARNING
#
# Do not put if else statements without if and else, gitlab yaml does not like
# this kind of scripting
#
# [ -f file_path ] && ok do this....

variables:
  HARBOR_USER: 'robot$$datafed+harbor_datafed_gitlab_ci_registry_2'
  REGISTRY: 'camden.ornl.gov'
  DATAFED_DEPENDENCIES_INSTALL_PATH: "/shared/install"
################################################################################
# STAGE: ci-infrastructure-check
################################################################################
# ci-infrastructure-check stage is designed to check that the infrastructure is
# up and running before attempting to launch the CI pipelines

check-ci-infrastructure:
  stage: ci-infrastructure-check
  tags:
    - datafed-infrastructure
  script:
    - |
      BUILD_INFRASTRUCTURE="FALSE"
      COMPUTE_INSTANCE_NAMES=("ci-datafed-arangodb" "ci-datafed-core" "ci-datafed-globus2" "ci-datafed-client")
      for INSTANCE_NAME in "${COMPUTE_INSTANCE_NAMES[@]}"; do
        if ! ./scripts/ci_pipeline_setup.sh --compute-instance-name "$INSTANCE_NAME"; then
          BUILD_INFRASTRUCTURE="TRUE"
        fi
      done
      if [ "$BUILD_INFRASTRUCTURE" == "TRUE" ]
      then
        cp gitlab_templates/build_ci_infrastructure.yml ci_infrastructure.yml
      else
        cp gitlab_templates/skip_ci_infrastructure.yml ci_infrastructure.yml
      fi
  resource_group: infrastructure_build
  artifacts:
    paths:
      - ci_infrastructure.yml 

run-trigger-job:
  stage: trigger-infrastructure
  trigger:
    include:
      - artifact: ci_infrastructure.yml
        job: check-ci-infrastructure
    strategy: depend
  resource_group: infrastructure_build

################################################################################
# STAGE: signal
################################################################################
# Stage is used to separte the trigger job from the remaining jobs and to act
# as an anchor for setting up dependencies
signal:
  stage: signal
  tags:
    - runner
  script:
    - echo "Starting Build"
  rules:
    - exists:
      - check-ci-infrastrucure
    - exists:
      - run-trigger-job
    - when: on_success

################################################################################
# STAGE: clear-docker-cache
################################################################################
# Used to clear out the cache on VMs where the images are being built
clear-core-cache:
  stage: clear-docker-cache
  needs: ["signal"]
  tags:
    - ci_1
  script:
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - docker system prune -f
    - ./scripts/ci_purge_images.sh

clear-repo-cache:
  stage: clear-docker-cache
  needs: ["signal"]
  tags:
    - ci_3
  script:
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - docker system prune -f
    - ./scripts/ci_purge_images.sh

clear-python-client-cache:
  stage: clear-docker-cache
  needs: ["signal"]
  tags:
    - ci_5
  script:
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - docker system prune -f
    - ./scripts/ci_purge_images.sh

################################################################################
# STAGE: build-base
################################################################################
# build runtime and depedencies containers
build-dependencies:
  stage: build-base
  variables:
    IMAGE_TAG: "datafed/dependencies"
    GIT_STRATEGY: clone
  tags:
    - docker
  script:
    - BRANCH_LOWER=$(echo "$CI_COMMIT_REF_NAME" | tr '[:upper:]' '[:lower:]')
    - docker system prune -f
    - docker build -f docker/Dockerfile.dependencies -t "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest" .
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - docker push "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest"

build-runtime:
  stage: build-base
  variables:
    IMAGE_TAG: "datafed/runtime"
    GIT_STRATEGY: clone
  tags:
    - docker
  script:
    - BRANCH_LOWER=$(echo "$CI_COMMIT_REF_NAME" | tr '[:upper:]' '[:lower:]')
    - docker system prune -f
    - docker build -f docker/Dockerfile.runtime -t "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest" .
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - docker push "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest"

#################################################################################
## STAGE: provision client
#################################################################################
provision-client:
  needs: ["signal"]
  variables:
    GIT_STRATEGY: clone
  stage: provision-client
  tags:
    - ci-datafed-client
  before_script:
    - export PATH=/opt/datafed/dependencies/bin:$PATH
  script:
    - ./scripts/generate_datafed.sh
    - ./scripts/install_client_dependencies.sh
      #  rules:
      #    - changes:
      #        - scripts/generate_datafed.sh
      #        - scripts/install_client_dependencies.sh
      #        - scripts/dependency_install_functions.sh
      #        - scripts/dependency_versions.sh

################################################################################
# STAGE: build
################################################################################
# Building containers for running services
build-ws:
  needs: ["build-dependencies", "build-runtime"]
  stage: build
  variables:
    IMAGE_TAG: "datafed/ws"
    GIT_STRATEGY: clone
  tags:
    - ci-datafed-core
    - docker
  rules:
    - changes:
        - docker/**/*
        - scripts/**/*
        - web/**/*
        - common/proto/**/*
        - .gitlab-ci.yml
      when: on_success
  script:
    - BRANCH_LOWER=$(echo "$CI_COMMIT_REF_NAME" | tr '[:upper:]' '[:lower:]')
    - echo "$BRANCH_LOWER"
    - ./scripts/generate_datafed.sh
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - docker build --build-arg DEPENDENCIES="${REGISTRY}/datafed/dependencies-${BRANCH_LOWER}:latest" --build-arg RUNTIME="${REGISTRY}/datafed/runtime-${BRANCH_LOWER}:latest" -f web/docker/Dockerfile -t "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest" .
    - docker push "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest"

build-core:
  needs: ["build-dependencies", "build-runtime"]
  stage: build
  variables:
    IMAGE_TAG: "datafed/core"
    GIT_STRATEGY: clone
  tags:
    - ci-datafed-core
    - docker
  rules:
    - changes:
        - docker/**/*
        - scripts/**/*
        - core/**/*
        - common/**/*
        - CMakeLists.txt
        - cmake/**/*
        - .gitlab-ci.yml
      when: on_success
  script:
    - BRANCH_LOWER=$(echo "$CI_COMMIT_REF_NAME" | tr '[:upper:]' '[:lower:]')
    - echo "$BRANCH_LOWER"
    - ./scripts/generate_datafed.sh
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - docker build --build-arg DEPENDENCIES="${REGISTRY}/datafed/dependencies-${BRANCH_LOWER}:latest" --build-arg RUNTIME="${REGISTRY}/datafed/runtime-${BRANCH_LOWER}:latest" -f core/docker/Dockerfile -t "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest" .
    - docker push "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest"

build-repo:
  needs: ["build-dependencies", "build-runtime"]
  stage: build
  variables:
    IMAGE_TAG: "datafed/repo"
    GIT_STRATEGY: clone
  tags:
    - ci-datafed-repo
    - docker
  rules:
    - changes:
        - docker/**/*
        - scripts/**/*
        - web/**/*
        - common/proto/**/*
        - .gitlab-ci.yml
      when: on_success
  script:
    - BRANCH_LOWER=$(echo "$CI_COMMIT_REF_NAME" | tr '[:upper:]' '[:lower:]')
    - echo "$BRANCH_LOWER"
    - ./scripts/generate_datafed.sh
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - docker build --build-arg DEPENDENCIES="${REGISTRY}/datafed/dependencies-${BRANCH_LOWER}:latest" --build-arg RUNTIME="${REGISTRY}/datafed/runtime-${BRANCH_LOWER}:latest" -f repository/docker/Dockerfile -t "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest" .
    - docker push "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest"

build-gcs-base:
  needs: ["build-dependencies", "build-runtime"]
  stage: build
  variables:
    IMAGE_TAG: "datafed/gcs-base"
    GIT_SUBMODULE_STRATEGY: recursive
    GIT_STRATEGY: clone
  tags:
    - ci-datafed-globus
    - docker
  rules:
    - changes:
        - docker/**/*
        - scripts/**/*
        - common/**/*
        - .gitlab-ci.yml
        - CMakeLists.txt
        - cmake/**/*
      when: on_success
  script:
    - BRANCH_LOWER=$(echo "$CI_COMMIT_REF_NAME" | tr '[:upper:]' '[:lower:]')
    - echo "$BRANCH_LOWER"
    - source "scripts/dependency_versions.sh"
    - cd "external/globus-connect-server-deploy/docker"
    - git checkout "$DATAFED_GCS_SUBMODULE_VERSION"
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - docker build --progress plain -t "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest" - < "./docker-files/Dockerfile.ubuntu-20.04"
    - docker push "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest"

build-gcs:
  needs: ["build-dependencies", "build-runtime", "build-gcs-base"]
  stage: build
  variables:
    IMAGE_TAG: "datafed/gcs"
    GIT_STRATEGY: clone
  tags:
    - ci-datafed-globus
    - docker
  rules:
    - changes:
        - docker/**/*
        - scripts/**/*
        - common/**/*
        - .gitlab-ci.yml
        - CMakeLists.txt
        - cmake/**/*
        - repository/docker/entrypoint_authz.sh
        - repository/docker/Dockerfile.gcs
      when: on_success
  script:
    - BRANCH_LOWER=$(echo "$CI_COMMIT_REF_NAME" | tr '[:upper:]' '[:lower:]')
    - echo "$BRANCH_LOWER"
    - ./scripts/generate_datafed.sh
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - docker build --build-arg DEPENDENCIES="${REGISTRY}/datafed/dependencies-${BRANCH_LOWER}:latest" --build-arg RUNTIME="${REGISTRY}/datafed/runtime-${BRANCH_LOWER}:latest" --build-arg GCS_IMAGE="${REGISTRY}/datafed/gcs-base-${BRANCH_LOWER}:latest" -f repository/docker/Dockerfile.gcs -t "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest" .
    - docker push "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest"

build-python-client-base:
  needs: ["clear-python-client-cache"]
  variables:
    IMAGE_TAG: "datafed/python-client-base"
    GIT_STRATEGY: clone
  stage: build
  tags:
    - docker
    - ci-datafed-client
  script:
    - BRANCH_LOWER=$(echo "$CI_COMMIT_REF_NAME" | tr '[:upper:]' '[:lower:]')
    - docker system prune -f
    - docker build -f python/docker/Dockerfile.python-client-base.ubuntu -t "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest" .
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - docker push "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest"


# Build foxx
build-foxx:
  needs: ["build-dependencies", "build-runtime"]
  stage: build
  variables:
    IMAGE_TAG: "datafed/foxx"
    GIT_STRATEGY: clone
  tags:
    - docker
  rules:
    - changes:
        - docker/**/*
        - scripts/**/*
        - web/**/*
        - common/proto/**/*
        - .gitlab-ci.yml
      when: on_success
  script:
    - BRANCH_LOWER=$(echo "$CI_COMMIT_REF_NAME" | tr '[:upper:]' '[:lower:]')
    - echo "$BRANCH_LOWER"
    - ./scripts/generate_datafed.sh
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - docker build --build-arg DEPENDENCIES="${REGISTRY}/datafed/dependencies-${BRANCH_LOWER}:latest" --build-arg RUNTIME="${REGISTRY}/datafed/runtime-${BRANCH_LOWER}:latest" -f docker/Dockerfile.foxx -t "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest" .
    - docker push "${REGISTRY}/${IMAGE_TAG}-${BRANCH_LOWER}:latest"


################################################################################
# STAGE: End to end setup arango
################################################################################

end-to-end-arango-setup:
  variables:
    GIT_STRATEGY: clone
  stage: end-to-end-setup-arango
  tags:
    - ci-datafed-arango
  script:
    - arangod --version
    - ./scripts/run_arango_service.sh

end-to-end-foxx-setup:
  variables:
    IMAGE_TAG: "datafed/foxx-"
    GIT_STRATEGY: clone
    HOST_LOG_FILE_PATH: "/shared/logs"
    CONTAINER_LOG_FILE_PATH: "/datafed/logs"
    DATAFED_DATABASE_HOST: "$CI_DATAFED_DATABASE_HOST"
    RUN_FILE: "run_foxx.sh"
  stage: end-to-end-setup-arango
  needs: ["end-to-end-arango-setup"]
  tags:
    - docker
  script:
    - sudo apt-get install jq -y
    - BRANCH_LOWER=$(echo "$CI_COMMIT_REF_NAME" | tr '[:upper:]' '[:lower:]')
    - mkdir -p "$HOST_LOG_FILE_PATH"
    - chmod o+w "${HOST_LOG_FILE_PATH}"
    - USER_ID=$(id -u)
    - chown gitlab-runner "$HOST_LOG_FILE_PATH"
    - echo "$BRANCH_LOWER"
    - ./scripts/generate_datafed.sh
    - env > env_file
    - mkdir foxx_tmp
    - ls -la foxx_tmp
    - if [ -f foxx_tmp/.foxx_is_installed ]; then rm foxx_tmp/.foxx_is_installed; fi
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - ./scripts/container_stop.sh -n "foxx-" -p
    - random_string=$(bash -c "cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w "10" | head -n 1")
    - echo "#!/bin/bash" > "${RUN_FILE}"
    - echo "docker run -d \\" >> "${RUN_FILE}"
    - echo "--name \"foxx-${BRANCH_LOWER}-${CI_COMMIT_SHORT_SHA}-${random_string}\" \\" >> "${RUN_FILE}"
    - echo "-e DATAFED_ZEROMQ_SYSTEM_SECRET=\"$CI_DATAFED_ZEROMQ_SYSTEM_SECRET\" \\" >> "${RUN_FILE}"
    - echo "-e DATAFED_DOMAIN=\"$CI_DATAFED_DOMAIN\" \\" >> "${RUN_FILE}"
    - echo "-e DATAFED_DATABASE_PASSWORD=\"$CI_DATAFED_DATABASE_PASSWORD\" \\" >> "${RUN_FILE}"
    - echo "-e DATAFED_DATABASE_IP_ADDRESS_PORT=\"$CI_DATAFED_DATABASE_IP_ADDRESS_PORT\" \\" >> "${RUN_FILE}"
    - echo "-e DATAFED_DATABASE_HOST=\"$CI_DATAFED_DATABASE_HOST\" \\" >> "${RUN_FILE}"
    - echo "-e DATAFED_DEFAULT_LOG_PATH=\"$CONTAINER_LOG_FILE_PATH\" \\" >> "${RUN_FILE}"
    - echo "-e UID=\"$USER_ID\" \\" >> "${RUN_FILE}"
    - echo "-v \"${HOST_LOG_FILE_PATH}:${CONTAINER_LOG_FILE_PATH}\" \\" >> "${RUN_FILE}"
    - echo "-v \"./foxx_tmp:/tmp\" \\" >> "${RUN_FILE}"
    - echo "-t \"${REGISTRY}/${IMAGE_TAG}${BRANCH_LOWER}:latest\"" >> "${RUN_FILE}"
    - chmod +x "${RUN_FILE}"
    - "./${RUN_FILE}"
    - sleep 10
      # Make sure container is running immediately after because it is meant to
      # be ephermal anyway, this is not the same for the other containers
    - ./scripts/container_run_test.sh -e -c "1" -t "${REGISTRY}/${IMAGE_TAG}${BRANCH_LOWER}:latest"
    - while [ ! -f "foxx_tmp/.foxx_is_installed" ]; do echo "Waiting for foxx_tmp/.foxx_is_installed"; sleep 10; done
    - ./scripts/ci_database_health_check.sh
  after_script:
    - rm -rf foxx_tmp

################################################################################
# STAGE: End to end setup
################################################################################

end-to-end-core-setup:
  variables:
    IMAGE_TAG: "datafed/core-"
    GIT_STRATEGY: clone
    HOST_LOG_FILE_PATH: "/shared/logs"
    CONTAINER_LOG_FILE_PATH: "/datafed/logs"
    DATAFED_DATABASE_HOST: "$CI_DATAFED_DATABASE_HOST"
  stage: end-to-end-setup
  needs: ["end-to-end-arango-setup", "end-to-end-foxx-setup"]
  tags:
    - ci-datafed-core
    - docker
  script:
    - BRANCH_LOWER=$(echo "$CI_COMMIT_REF_NAME" | tr '[:upper:]' '[:lower:]')
    - mkdir -p "$HOST_LOG_FILE_PATH"
    - chmod o+w "${HOST_LOG_FILE_PATH}"
    - USER_ID=$(id -u)
    - chown gitlab-runner "$HOST_LOG_FILE_PATH"
    - echo "$BRANCH_LOWER"
    - ./scripts/generate_datafed.sh
    - env > env_file
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - ./scripts/container_stop.sh -n "core-" -p
    - ./scripts/ci_database_health_check.sh
    - if [ ! -d "/shared/keys" ]; then mkdir -p "/shared/keys"; fi
    - cat $CI_DATAFED_CORE_PUB_KEY > /shared/keys/datafed-core-key.pub
    - cat $CI_DATAFED_CORE_PRIV_KEY > /shared/keys/datafed-core-key.priv
    - random_string=$(bash -c "cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w "10" | head -n 1")
    - echo "#!/bin/bash" > run_core.sh
    - echo "docker run -d \\" >> run_core.sh
    - echo "--name \"core-${BRANCH_LOWER}-${CI_COMMIT_SHORT_SHA}-${random_string}\" \\" >> run_core.sh
    - echo "-e DATAFED_GLOBUS_APP_SECRET=\"$CI_DATAFED_GLOBUS_APP_SECRET\" \\" >> run_core.sh
    - echo "-e DATAFED_GLOBUS_APP_ID=\"$CI_DATAFED_GLOBUS_APP_ID\" \\" >> run_core.sh
    - echo "-e DATAFED_ZEROMQ_SESSION_SECRET=\"$CI_DATAFED_ZEROMQ_SESSION_SECRET\" \\" >> run_core.sh
    - echo "-e DATAFED_ZEROMQ_SYSTEM_SECRET=\"$CI_DATAFED_ZEROMQ_SYSTEM_SECRET\" \\" >> run_core.sh
    - echo "-e DATAFED_DOMAIN=\"$CI_DATAFED_DOMAIN\" \\" >> run_core.sh
    - echo "-e DATAFED_DATABASE_PASSWORD=\"$CI_DATAFED_DATABASE_PASSWORD\" \\" >> run_core.sh
    - echo "-e DATAFED_DATABASE_IP_ADDRESS_PORT=\"$CI_DATAFED_DATABASE_IP_ADDRESS_PORT\" \\" >> run_core.sh
    - echo "-e DATAFED_DEFAULT_LOG_PATH=\"$CONTAINER_LOG_FILE_PATH\" \\" >> run_core.sh
    - echo "-e UID=\"$USER_ID\" \\" >> run_core.sh
    - echo "-p 7513:7513 \\" >> run_core.sh
    - echo "-p 7512:7512 \\" >> run_core.sh
    - echo "-v \"${HOST_LOG_FILE_PATH}:${CONTAINER_LOG_FILE_PATH}\" \\" >> run_core.sh
    - echo "-v \"/shared/keys/datafed-core-key.pub\":/opt/datafed/keys/datafed-core-key.pub \\" >> run_core.sh
    - echo "-v \"/shared/keys/datafed-core-key.priv\":/opt/datafed/keys/datafed-core-key.priv \\" >> run_core.sh
    - echo "-t \"${REGISTRY}/${IMAGE_TAG}${BRANCH_LOWER}:latest\"" >> run_core.sh
    - chmod +x run_core.sh
    - ./run_core.sh
    - sleep 10
    - ./scripts/container_run_test.sh -e -c "1" -t "${REGISTRY}/${IMAGE_TAG}${BRANCH_LOWER}:latest" 

end-to-end-ws-setup:
  variables:
    IMAGE_TAG: "datafed/ws-"
    GIT_STRATEGY: clone
    HOST_LOG_FILE_PATH: "/shared/logs"
    CONTAINER_LOG_FILE_PATH: "/datafed/logs"
    DATAFED_WEB_KEY_DIR: "/shared/keys"
    DATAFED_WEB_CERT_NAME: "cert.crt"
    DATAFED_WEB_KEY_NAME: "cert.key"
    DATAFED_WEB_CERT_PATH: "${DATAFED_WEB_KEY_DIR}/${DATAFED_WEB_CERT_NAME}"
    DATAFED_WEB_CSR_PATH: "${DATAFED_WEB_KEY_DIR}/cert.csr"
    DATAFED_WEB_KEY_PATH: "${DATAFED_WEB_KEY_DIR}/${DATAFED_WEB_KEY_NAME}"
  stage: end-to-end-setup
  needs : ["end-to-end-core-setup"]
  tags:
    - ci-datafed-core
    - docker
  script:
    - BRANCH_LOWER=$(echo "$CI_COMMIT_REF_NAME" | tr '[:upper:]' '[:lower:]')
    - echo "$BRANCH_LOWER"
    - mkdir -p "$HOST_LOG_FILE_PATH"
    - mkdir -p "${DATAFED_WEB_KEY_DIR}"
    - ./scripts/ci_setup_web_certs.sh
    - chmod o+w "${HOST_LOG_FILE_PATH}"
    - chown gitlab-runner "$HOST_LOG_FILE_PATH"
    - ./scripts/generate_datafed.sh
    - docker login  "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - USER_ID=$(id -u)
    - GROUP_ID=$(id -g)
    - CORE_ADDRESS=$(hostname -I | awk '{print $1}')
    - cat $CI_DATAFED_CORE_PUB_KEY > /shared/keys/datafed-core-key.pub
    - env
    - ./scripts/container_stop.sh -n "ws-" -p 
    - random_string=$(bash -c "cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w "10" | head -n 1")
    - echo "#!/bin/bash" > run_web.sh
    - echo "docker run -d \\" >> run_web.sh
    - echo "--name \"ws-${BRANCH_LOWER}-${CI_COMMIT_SHORT_SHA}-${random_string}\" \\" >> run_web.sh
    - echo "-e DATAFED_GLOBUS_APP_SECRET=\"$CI_DATAFED_GLOBUS_APP_SECRET\" \\" >> run_web.sh
    - echo "-e DATAFED_GLOBUS_APP_ID=\"$CI_DATAFED_GLOBUS_APP_ID\" \\" >> run_web.sh
    - echo "-e DATAFED_ZEROMQ_SESSION_SECRET=\"$CI_DATAFED_ZEROMQ_SESSION_SECRET\" \\" >> run_web.sh
    - echo "-e DATAFED_ZEROMQ_SYSTEM_SECRET=\"$CI_DATAFED_ZEROMQ_SYSTEM_SECRET\" \\" >> run_web.sh
    - echo "-e DATAFED_DOMAIN=\"$CI_DATAFED_DOMAIN\" \\" >> run_web.sh
    - echo "-e DATAFED_WEB_CERT_PATH=\"/opt/datafed/keys/${DATAFED_WEB_CERT_NAME}\" \\" >> run_web.sh
    - echo "-e DATAFED_WEB_KEY_PATH=\"/opt/datafed/keys/${DATAFED_WEB_KEY_NAME}\" \\" >> run_web.sh
    - echo "-e DATAFED_DEFAULT_LOG_PATH=\"${CONTAINER_LOG_FILE_PATH}\" \\" >> run_web.sh
    - echo "-e DATAFED_CORE_ADDRESS_PORT_INTERNAL=\"$CORE_ADDRESS:7513\" \\" >> run_web.sh
    - echo "-e UID=\"$USER_ID\" \\" >> run_web.sh
    - echo "-p 443:443 \\" >> run_web.sh
    - echo "-v \"${HOST_LOG_FILE_PATH}:${CONTAINER_LOG_FILE_PATH}\" \\" >> run_web.sh
    - echo "-v \"/shared/keys/datafed-core-key.pub:/opt/datafed/keys/datafed-core-key.pub\" \\" >> run_web.sh
    - echo "-v \"${DATAFED_WEB_CERT_PATH}:/opt/datafed/keys/${DATAFED_WEB_CERT_NAME}\" \\" >> run_web.sh
    - echo "-v \"${DATAFED_WEB_KEY_PATH}:/opt/datafed/keys/${DATAFED_WEB_KEY_NAME}\" \\" >> run_web.sh
    - echo "-t \"${REGISTRY}/${IMAGE_TAG}${BRANCH_LOWER}:latest\" " >> run_web.sh
    - chmod +x run_web.sh
    - ./run_web.sh
    - sleep 30
    - ./scripts/container_run_test.sh -e -c "1" -t "${REGISTRY}/${IMAGE_TAG}${BRANCH_LOWER}:latest" 

# Repo server currently will crash on startup if it cannot connect to the core
# server.
end-to-end-repo-setup:
  variables:
    IMAGE_TAG: "datafed/repo-"
    GIT_STRATEGY: clone
    HOST_LOG_FILE_PATH: "/shared/logs"
    CONTAINER_LOG_FILE_PATH: "/datafed/logs"
    DATAFED_HOST_COLLECTION_MOUNT: "/shared/collections"
  stage: end-to-end-setup
  needs: ["end-to-end-ws-setup"]
  tags:
    - ci-datafed-globus
    - docker
  script:
    - BRANCH_LOWER=$(echo "$CI_COMMIT_REF_NAME" | tr '[:upper:]' '[:lower:]')
    - echo "$BRANCH_LOWER"
    - mkdir -p "$HOST_LOG_FILE_PATH"
    - if [ ! -d "${DATAFED_HOST_COLLECTION_MOUNT}" ]; then mkdir -p "${DATAFED_HOST_COLLECTION_MOUNT}"; fi
    - chmod o+w "${HOST_LOG_FILE_PATH}"
    - USER_ID=$(id -u)
    - chown gitlab-runner "$HOST_LOG_FILE_PATH"
    - ./scripts/generate_datafed.sh
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - ./scripts/container_stop.sh -n "repo-" -p
    - random_string=$(bash -c "cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w "10" | head -n 1")
    - cat $CI_DATAFED_CORE_PUB_KEY > /shared/datafed-repo-key.pub
    - cat $CI_DATAFED_CORE_PRIV_KEY > /shared/datafed-repo-key.priv
    - echo "#!/bin/bash" > run_repo.sh
    - echo "docker run -d \\" >> run_repo.sh
    - echo "--name \"repo-${BRANCH_LOWER}-${CI_COMMIT_SHORT_SHA}-${random_string}\" \\" >> run_repo.sh
    - echo "-e DATAFED_GLOBUS_APP_SECRET=\"$CI_DATAFED_GLOBUS_APP_SECRET\" \\" >> run_repo.sh
    - echo "-e DATAFED_GLOBUS_APP_ID=\"$CI_DATAFED_GLOBUS_APP_ID\" \\" >> run_repo.sh
    - echo "-e DATAFED_ZEROMQ_SESSION_SECRET=\"$CI_DATAFED_ZEROMQ_SESSION_SECRET\" \\" >> run_repo.sh
    - echo "-e DATAFED_ZEROMQ_SYSTEM_SECRET=\"$CI_DATAFED_ZEROMQ_SYSTEM_SECRET\" \\" >> run_repo.sh
    - echo "-e DATAFED_HTTPS_SERVER_PORT=\"443\" \\" >> run_repo.sh
    - echo "-e DATAFED_DOMAIN=\"$CI_DATAFED_DOMAIN\" \\" >> run_repo.sh
    - echo "-e DATAFED_CORE_ADDRESS_PORT_INTERNAL=\"${CI_DATAFED_DOMAIN}:7513\" \\" >> run_repo.sh
    - echo "-e DATAFED_DEFAULT_LOG_PATH=\"$CONTAINER_LOG_FILE_PATH\" \\" >> run_repo.sh
    - echo "-e DATAFED_GCS_COLLECTION_ROOT_PATH=\"/mnt/datafed\" \\" >> run_repo.sh
    - echo "-e UID=\"$USER_ID\" \\" >> run_repo.sh
    - echo "-p 9000:9000 \\" >> run_repo.sh
    - echo "-v \"${HOST_LOG_FILE_PATH}:${CONTAINER_LOG_FILE_PATH}\" \\" >> run_repo.sh
    - echo "-v \"${DATAFED_HOST_COLLECTION_MOUNT}:/mnt/datafed\" \\" >> run_repo.sh
    - echo "-v \"/shared/datafed-repo-key.pub\":/opt/datafed/keys/datafed-repo-key.pub \\" >> run_repo.sh
    - echo "-v \"/shared/datafed-repo-key.priv\":/opt/datafed/keys/datafed-repo-key.priv \\" >> run_repo.sh
    - echo "-t \"${REGISTRY}/${IMAGE_TAG}${BRANCH_LOWER}:latest\"" >> run_repo.sh
    - chmod +x run_repo.sh
    - ./run_repo.sh
    - sleep 10
    - ./scripts/container_run_test.sh -e -c "1" -t "${REGISTRY}/${IMAGE_TAG}${BRANCH_LOWER}:latest" 

# Requires setting up Globus Connect Server, requires firewall exceptions on
# the machine running this.
# Note we need the certificates to be available on the gcs-authz container
# if it is meant to be run on the same machine as the metadata services
# because the Apache web server can then route traffic appropriately, if 
# run separate from the metadata services it should not be needed.
# NOTE it should also run after the repo service because when the form is
# generated, it requires the repo server public key.
end-to-end-gcs-authz-setup:
  variables:
    IMAGE_TAG: "datafed/gcs-"
    HOST_LOG_FILE_PATH: "/shared/logs"
    CONTAINER_LOG_FILE_PATH: "/datafed/logs"
    GIT_STRATEGY: clone
    DATAFED_HOST_COLLECTION_MOUNT: "/shared/collections"
    DATAFED_GLOBUS_DIR: "/shared/globus"
  stage: end-to-end-setup
  needs: ["end-to-end-repo-setup"]
  tags:
    - ci-datafed-globus
    - docker
  script:
    - BRANCH_LOWER=$(echo "$CI_COMMIT_REF_NAME" | tr '[:upper:]' '[:lower:]')
    - echo "$BRANCH_LOWER"
    - mkdir -p "$HOST_LOG_FILE_PATH"
    - mkdir -p "${DATAFED_GLOBUS_DIR}"
    - cp "${CI_DATAFED_GCS_DEPLOYMENT_KEY}" "${DATAFED_GLOBUS_DIR}/deployment-key.json"
    - cp "${CI_DATAFED_GCS_CLIENT_CRED}" "${DATAFED_GLOBUS_DIR}/client_cred.json"
    - USER_ID=$(id -u)
    - chmod o+w "${HOST_LOG_FILE_PATH}"
    - chown gitlab-runner "$HOST_LOG_FILE_PATH"
    - ./scripts/generate_datafed.sh
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY}"
    - ./scripts/container_stop.sh -n "gcs-authz" -p
    - random_string=$(bash -c "cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w "10" | head -n 1")
    - cat $CI_DATAFED_CORE_PUB_KEY > /shared/datafed-repo-key.pub
    - cat $CI_DATAFED_CORE_PRIV_KEY > /shared/datafed-repo-key.priv
    - echo "#!/bin/bash" > run_globus.sh
    - echo "docker run -d \\" >> run_globus.sh
    - echo "--name \"gcs-authz-${BRANCH_LOWER}-${CI_COMMIT_SHORT_SHA}-${random_string}\" \\" >> run_globus.sh
    - echo "--network host \\" >> run_globus.sh
    - echo "-e DATAFED_GLOBUS_APP_SECRET=\"$CI_DATAFED_GLOBUS_APP_SECRET\" \\" >> run_globus.sh
    - echo "-e DATAFED_GLOBUS_APP_ID=\"$CI_DATAFED_GLOBUS_APP_ID\" \\" >> run_globus.sh
    - echo "-e DATAFED_ZEROMQ_SESSION_SECRET=\"$CI_DATAFED_ZEROMQ_SESSION_SECRET\" \\" >> run_globus.sh
    - echo "-e DATAFED_ZEROMQ_SYSTEM_SECRET=\"$CI_DATAFED_ZEROMQ_SYSTEM_SECRET\" \\" >> run_globus.sh
    - echo "-e DATAFED_DOMAIN=\"$CI_DATAFED_DOMAIN\" \\" >> run_globus.sh
    - echo "-e DATAFED_HTTPS_SERVER_PORT=\"443\" \\" >> run_globus.sh
    - echo "-e DATAFED_DEFAULT_LOG_PATH=\"$CONTAINER_LOG_FILE_PATH\" \\" >> run_globus.sh
    - echo "-e DATAFED_CORE_ADDRESS_PORT_INTERNAL=\"${CI_DATAFED_DOMAIN}:7513\" \\" >> run_globus.sh
    - echo "-e DATAFED_GCS_ROOT_NAME=\"${CI_DATAFED_GCS_ROOT_NAME}\" \\" >> run_globus.sh
    - echo "-e DATAFED_GCS_COLLECTION_ROOT_PATH=\"/mnt/datafed\" \\" >> run_globus.sh
    - echo "-e DATAFED_GLOBUS_SUBSCRIPTION=\"${CI_DATAFED_GLOBUS_SUBSCRIPTION}\" \\" >> run_globus.sh
    - echo "-e DATAFED_GLOBUS_CONTROL_PORT=\"443\" \\" >> run_globus.sh
    - echo "-e DATAFED_REPO_USER=\"datafed\" \\" >> run_globus.sh
    - echo "-e DATAFED_AUTHZ_USER=\"datafed\" \\" >> run_globus.sh
    - echo "-e UID=\"$USER_ID\" \\" >> run_globus.sh
    - echo "-e BUILD_WITH_METADATA_SERVICES=\"FALSE\" \\" >> run_globus.sh
    - echo "-e DATAFED_REPO_ID_AND_DIR=\"${CI_DATAFED_REPO_ID_AND_DIR}\" \\" >> run_globus.sh
    - echo "-e DATAFED_GCS_IP=\"${CI_DATAFED_GCS_IP}\" \\" >> run_globus.sh
    - echo "-e DATAFED_REPO_DOMAIN=\"${CI_DATAFED_REPO_DOMAIN}\" \\" >> run_globus.sh
    - echo "-v \"${DATAFED_GLOBUS_DIR}:/opt/datafed/globus\" \\" >> run_globus.sh
    - echo "-v \"${HOST_LOG_FILE_PATH}:${CONTAINER_LOG_FILE_PATH}\" \\" >> run_globus.sh
    - echo "-v \"${DATAFED_HOST_COLLECTION_MOUNT}:/mnt/datafed\" \\" >> run_globus.sh
    - echo "-v \"/shared/datafed-repo-key.pub\":/opt/datafed/keys/datafed-repo-key.pub \\" >> run_globus.sh
    - echo "-v \"/shared/datafed-repo-key.priv\":/opt/datafed/keys/datafed-repo-key.priv \\" >> run_globus.sh
    - echo "-t \"${REGISTRY}/${IMAGE_TAG}${BRANCH_LOWER}:latest\"" >> run_globus.sh
    - if [ -f "${DATAFED_GLOBUS_DIR}/${CI_DATAFED_REPO_ID_AND_DIR}-repo-form.sh" ]; then rm "${DATAFED_GLOBUS_DIR}/${CI_DATAFED_REPO_ID_AND_DIR}-repo-form.sh"; fi
    - chmod +x run_globus.sh
    - ./run_globus.sh
    - while [ ! -f "${DATAFED_GLOBUS_DIR}/${CI_DATAFED_REPO_ID_AND_DIR}-repo-form.sh" ]; do echo "Waiting for ${DATAFED_GLOBUS_DIR}/${CI_DATAFED_REPO_ID_AND_DIR}-repo-form.sh"; sleep 10; done
    - cat "${DATAFED_GLOBUS_DIR}/${CI_DATAFED_REPO_ID_AND_DIR}-repo-form.sh"
    - ./scripts/container_run_test.sh -e -c "1" -t "${REGISTRY}/${IMAGE_TAG}${BRANCH_LOWER}:latest"
    - cp ${DATAFED_GLOBUS_DIR}/${CI_DATAFED_REPO_ID_AND_DIR}-repo-form.sh .
    - cp ${DATAFED_GLOBUS_DIR}/${CI_DATAFED_REPO_ID_AND_DIR}-repo-form.json .
  artifacts:
    paths:
      - "${CI_DATAFED_REPO_ID_AND_DIR}-repo-form.sh"
      - "${CI_DATAFED_REPO_ID_AND_DIR}-repo-form.json"


end_to_end_client-test:
  variables:
    GIT_STRATEGY: clone
    DATAFED_DATABASE_HOST: "${CI_DATAFED_DATABASE_HOST}"
    DATAFED_DATABASE_ZEROMQ_SYSTEM_SECRET: "${CI_DATAFED_DATABASE_ZEROMQ_SYSTEM_SECRET}"
    DATAFED_DATABASE_PASSWORD: "${CI_DATAFED_DATABASE_PASSWORD}"
    DATAFED_USER89_PASSWORD: "${CI_DATAFED_USER89_PASSWORD}"
    DATAFED_USER89_GLOBUS_REFRESH_TOKEN: "${CI_DATAFED_USER89_GLOBUS_REFRESH_TOKEN}"
    DATAFED_USER89_GLOBUS_ACCESS_TOKEN: "${CI_DATAFED_USER89_GLOBUS_ACCESS_TOKEN}"
    DATAFED_USER89_GLOBUS_UUID: "${CI_DATAFED_USER89_GLOBUS_UUID}"
    DATAFED_USER99_PASSWORD: "${CI_DATAFED_USER99_PASSWORD}"
    DATAFED_USER99_GLOBUS_REFRESH_TOKEN: "${CI_DATAFED_USER99_GLOBUS_REFRESH_TOKEN}"
    DATAFED_USER99_GLOBUS_ACCESS_TOKEN: "${CI_DATAFED_USER99_GLOBUS_ACCESS_TOKEN}"
    DATAFED_USER99_GLOBUS_UUID: "${CI_DATAFED_USER99_GLOBUS_UUID}"
    DATAFED_ZEROMQ_SYSTEM_SECRET: "${CI_DATAFED_ZEROMQ_SYSTEM_SECRET}"
    DATAFED_DOMAIN: "${CI_DATAFED_DOMAIN}"
    DATAFED_PYTHON_CLIENT_ALLOW_SELF_SIGNED_CERTS: "TRUE"
  stage: end-to-end-test
  dependencies:
    - end-to-end-gcs-authz-setup
  needs: ["end-to-end-gcs-authz-setup"]
  tags:
    - ci-datafed-client
  script:
    - export DATAFED_REPO_FORM_PATH="$(pwd)/${CI_DATAFED_REPO_ID_AND_DIR}-repo-form.json"
    - env > env_file
    - echo "Testing"
    - ./scripts/generate_datafed.sh
    - >
      cmake -S. -B build
      -DENABLE_FOXX_TESTS=OFF
      -DBUILD_CORE_SERVER=OFF
      -DBUILD_COMMON=OFF
      -DBUILD_WEB_SERVER=OFF
      -DBUILD_DOCS=OFF
      -DBUILD_PYTHON_CLIENT=ON
      -DBUILD_TESTS=ON
      -DENABLE_END_TO_END_TESTS=ON
      -DINSTALL_FOXX=OFF
    - cmake --build build
    - cmake --build build --target pydatafed
    - cmake --build build --target test

deploy-pypi-package-test:
  variables:
    GIT_STRATEGY: clone
    DATAFED_PYPI_REPO: "datafed-test"
    DATAFED_PYPI_REPO_TOKEN: "$CI_DATAFED_PYPI_REPO_TOKEN_TEST"
    DATAFED_DEPENDENCIES_INSTALL_PATH: "/shared/install"
  stage: deploy-pypi-package
  when: manual
  tags:
    - ci-datafed-client
  script:
    - PYPI_VER=$(curl -s https://pypi.org/pypi/datafed-test/json | jq -r .info.version)
    - echo "Latest version $PYPI_VER"
    - RELEASE_IDENTIFIER="${PYPI_VER#*b}" 
    - python3 -m pip install twine
    - export RELEASE_IDENTIFIER=$((10#$RELEASE_IDENTIFIER + 1))
    - echo "Incremented release identifier $RELEASE_IDENTIFIER"
    - export TWINE_CONFIG_FILE="$(pwd)/.pypirc"
    - ./scripts/ci_generate_pypirc.sh
    - env > env_file
    - echo "Testing"
    - sed -i 's/^set(DATAFED_PYTHON_CLIENT_RELEASE_TYPE.*/set(DATAFED_PYTHON_CLIENT_RELEASE_TYPE "b")/' ./cmake/Version.cmake
    - sed -i "s/^set(DATAFED_PYTHON_CLIENT_PRE_RELEASE_IDENTIFER.*/set(DATAFED_PYTHON_CLIENT_PRE_RELEASE_IDENTIFER \"$RELEASE_IDENTIFIER\")/" ./cmake/Version.cmake
    - cat ./cmake/Version.cmake
    - ./scripts/generate_datafed.sh
    - >
      cmake -S. -B build
      -DENABLE_FOXX_TESTS=OFF
      -DBUILD_CORE_SERVER=OFF
      -DBUILD_COMMON=OFF
      -DBUILD_WEB_SERVER=OFF
      -DBUILD_DOCS=OFF
      -DBUILD_PYTHON_CLIENT=ON
      -DBUILD_TESTS=OFF
      -DENABLE_END_TO_END_TESTS=OFF
      -DINSTALL_FOXX=OFF
    - cmake --build build
    - cmake --build build --target pydatafed
    - cd python/datafed_pkg/
    - python3 setup.py sdist bdist_wheel
    - python3 -m twine upload --config-file "$TWINE_CONFIG_FILE" dist/*
 

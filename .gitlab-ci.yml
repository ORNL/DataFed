stages:
  - build-base
  - deploy-base
  - build
  - deploy

before_script:
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

build-ws-base:
  variables:
    IMAGE_TAG: "datafed-web-base"
  stage: build-base
  tags:
    - datafed
  script:
    - docker build -f dockerfiles/Dockerfile.web-base.ubuntu -t ${IMAGE_TAG} .

build-core-base:
  variables:
    IMAGE_TAG: "datafed-core-base"
  stage: build-base
  tags:
    - datafed
  script:
    - docker build -f dockerfiles/Dockerfile.core-base.ubuntu -t ${IMAGE_TAG} .

build-repo-base:
  variables:
    IMAGE_TAG: "datafed-repo-base"
  stage: build-base
  tags:
    - datafed
  script:
    - docker build -f dockerfiles/Dockerfile.repo-base.ubuntu -t ${IMAGE_TAG} .

deploy-ws-base:
  stage: deploy-base
  tags:
    - datafed
  script:
    - docker push datafed-web-base .

deploy-core-base:
  stage: deploy-base
  tags:
    - datafed
  script:
    - docker push datafed-core-base .

deploy-repo-base:
  stage: deploy-base
  tags:
    - datafed
  script:
    - docker push datafed-repo-base .

build-ws:
  variables:
    IMAGE_TAG: "datafed-web:$CI_COMMIT_REF_NAME"
  stage: build
  tags:
    - datafed
  script:
    - docker build -f dockerfiles/Dockerfile.web.ubuntu -t ${IMAGE_TAG} .

build-core:
  variables:
    IMAGE_TAG: "datafed-core:$CI_COMMIT_REF_NAME"
  stage: build
  tags:
    - datafed
  script:
    - docker build -f dockerfiles/Dockerfile.core.ubuntu -t ${IMAGE_TAG} .

build-repo:
  variables:
    IMAGE_TAG: "datafed-repo:$CI_COMMIT_REF_NAME"
  stage: build
  tags:
    - datafed
  script:
    - docker build -f dockerfiles/Dockerfile.repo-base.ubuntu -t ${IMAGE_TAG} .

deploy-ws:
  variables:
    IMAGE_TAG: "datafed-web:$CI_COMMIT_REF_NAME"
  stage: deploy
  tags:
    - datafed
  script:
    - docker push ${IMAGE_TAG} .

deploy-core:
  variables:
    IMAGE_TAG: "datafed-core:$CI_COMMIT_REF_NAME"
  stage: deploy
  tags:
    - datafed
  script:
    - docker push ${IMAGE_TAG} .

deploy-repo:
  variables:
    IMAGE_TAG: "datafed-repo:$CI_COMMIT_REF_NAME"
  stage: deploy
  tags:
    - datafed
  script:
    - docker push ${IMAGE_TAG} .

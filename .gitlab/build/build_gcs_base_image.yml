---
stages:
  - build

include:
  - local: .gitlab/common.yml

build-gcs-base:
  stage: build
  variables:
    PROJECT: "datafed"
    COMPONENT: "gcs-base"
    GIT_SUBMODULE_STRATEGY: recursive
    GIT_STRATEGY: clone
    DATAFED_HARBOR_REGISTRY: "$REGISTRY" # needed by c_harbor_artifact_count
    BUILD_INTERMEDIATE: "FALSE"
    GCS_BASE_IMAGE_DISTRO: "debian-12"
  tags:
    - ci-datafed-globus
    - docker
  rules:
    - changes:
        - docker/**/*
        - scripts/**/*
        - common/**/*
        - .gitlab-ci.yml
        - CMakeLists.txt
        - cmake/**/*
      when: on_success
  script:
    - BRANCH_LOWER=$(echo "$CI_COMMIT_REF_NAME" | tr '[:upper:]' '[:lower:]')
    - echo "$BRANCH_LOWER"
    - source "scripts/dependency_versions.sh"
    - cd "external/globus-connect-server-deploy/docker"
    - git checkout "$DATAFED_GCS_SUBMODULE_VERSION"
    - docker login "${REGISTRY}" -u "${HARBOR_USER}" -p "${HARBOR_DATAFED_GITLAB_CI_REGISTRY_TOKEN}"
    - docker build --no-cache --progress plain -t "${REGISTRY}/${PROJECT}/${COMPONENT}-${BRANCH_LOWER}:latest" - < "./docker-files/Dockerfile.${GCS_BASE_IMAGE_DISTRO}"
    - docker tag "${REGISTRY}/${PROJECT}/${COMPONENT}-${BRANCH_LOWER}:latest" "${REGISTRY}/${PROJECT}/${COMPONENT}-${BRANCH_LOWER}:$CI_COMMIT_SHA"
    - export DATAFED_HARBOR_REPOSITORY="${COMPONENT}-${BRANCH_LOWER}"
    - export DATAFED_HARBOR_USERNAME="${HARBOR_USER}"
    - export DATAFED_HARBOR_PASSWORD="${HARBOR_DATAFED_GITLAB_CI_REGISTRY_TOKEN}"
    - docker push "${REGISTRY}/${PROJECT}/${DATAFED_HARBOR_REPOSITORY}:latest"
    - docker push "${REGISTRY}/${PROJECT}/${DATAFED_HARBOR_REPOSITORY}:$CI_COMMIT_SHA"
    - cd "${CI_PROJECT_DIR}"
    - |
      while [ "$(${CI_PROJECT_DIR}/scripts/ci_harbor_artifact_count.sh -r ${DATAFED_HARBOR_REPOSITORY})" == "0" ]; do
        echo "Artifact missing from harbor..."
        docker push "${REGISTRY}/${PROJECT}/${DATAFED_HARBOR_REPOSITORY}:latest"
        docker push "${REGISTRY}/${PROJECT}/${DATAFED_HARBOR_REPOSITORY}:$CI_COMMIT_SHA"
        sleep 5  # Optional: Add a sleep to avoid busy waiting 
      done
    - cat "${CI_PROJECT_DIR}/harbor_check.log"

retag-image:
  extends: .docker_retag_image
  stage: build
  variables:
    PROJECT: "datafed"
    COMPONENT: "gcs-base"
    GIT_STRATEGY: clone
    DATAFED_HARBOR_REGISTRY: "$REGISTRY" # needed by c_harbor_artifact_count
    BUILD_INTERMEDIATE: "FALSE"
  tags:
    - docker
  rules:
    - changes:
        - docker/**/*
        - scripts/**/*
        - common/**/*
        - .gitlab-ci.yml
        - CMakeLists.txt
        - cmake/**/*
      when: never
    - when: on_success

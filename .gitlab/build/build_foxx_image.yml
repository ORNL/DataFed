---
stages:
  - build

include:
  - local: .gitlab/common.yml

build-foxx:
  extends: .docker_build_script
  stage: build
  variables:
    PROJECT: "datafed"
    COMPONENT: "foxx"
    GIT_STRATEGY: clone
    DOCKER_FILE_PATH: "docker/Dockerfile.foxx"
    DATAFED_HARBOR_REGISTRY: "$REGISTRY" # needed by c_harbor_artifact_count
    BUILD_INTERMEDIATE: "FALSE"
  tags:
    - docker
  rules:
    - changes:
        - docker/**/*
        - scripts/**/*
        - cmake/**/*
        - core/database/**/*
        - core/CMakeLists.txt
        - common/proto/**/*
        - .gitlab-ci.yml
        - CMakeLists.txt
      when: on_success

retag-image:
  extends: .docker_retag_image
  stage: build
  variables:
    PROJECT: "datafed"
    COMPONENT: "foxx"
    GIT_STRATEGY: clone
    DATAFED_HARBOR_REGISTRY: "$REGISTRY" # needed by c_harbor_artifact_count
    BUILD_INTERMEDIATE: "FALSE"
  tags:
    - docker
  rules:
    - changes:
        - docker/**/*
        - scripts/**/*
        - cmake/**/*
        - core/database/**/*
        - core/CMakeLists.txt
        - common/proto/**/*
        - .gitlab-ci.yml
        - CMakeLists.txt
      when: never
    - when: on_success
